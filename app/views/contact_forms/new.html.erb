<div style="max-width: 400px;" class="mx-auto">
<h2>お問い合わせフォーム</h2>

<%= form_with model: @contact_form, url: contact_forms_path,local: true, html:  {  id: "contact_form", class: "needs-validation", novalidate: true } do |f| %>
  <div class="mb-3">
    <%= f.label :name, "お名前",  class: "form-label"  %>
    <%= f.text_field :name, class: "form-control", required: true, maxlength: 30 %>
    <div class="invalid-feedback">お名前を入力してください（30文字以内）。</div>
  </div>

  <div class="mb-3">
    <%= f.label :email, "メールアドレス" ,  class: "form-label"  %>
    <%= f.email_field :email, class: "form-control", required: true %>
    <div class="invalid-feedback">有効なメールアドレスを入力してください。</div>
  </div>

  <div class="mb-3">
    <%= f.label :message, "お問い合わせ内容" ,  class: "form-label" %>
    <%= f.text_area :message, class: "form-control", rows: 5, required: true %>
    <div class="invalid-feedback">お問い合わせ内容を入力してください。</div>
  </div>


  <!-- reCAPTCHAのトークンを格納するhiddenフィールド -->
  <%= f.hidden_field :recaptcha_token, id: "recaptcha_token" %>


  <%= f.submit "送信", class: "btn btn-primary" %>
<% end %>

</div>

<!-- reCAPTCHA v3のJavaScriptライブラリを読み込み -->
<script src="https://www.google.com/recaptcha/api.js?render=<%= Rails.application.credentials.dig(:recaptcha, :site_key) %>"></script>


<script>
 
  document.addEventListener("turbo:load", function() {
    const form = document.getElementById("contact_form");

    form.addEventListener("submit", function(event) {
      // バリデーションチェック
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
        form.classList.add("was-validated");
        return;
      }

      // バリデーションが通った場合にreCAPTCHAトークン生成
      event.preventDefault(); // デフォルト送信を防止
      grecaptcha.ready(function() {
        grecaptcha.execute("<%= Rails.application.credentials.dig(:recaptcha, :site_key) %>", { action: "submit" })
          .then(function(token) {
            document.getElementById("recaptcha_token").value = token;
            form.submit(); // トークン設定後にフォーム送信
          });
      });
    });
  });

</script>
